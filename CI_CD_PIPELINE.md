# üöÄ CI/CD Pipeline - Food Orders CRM

## Pipeline Completo

```mermaid
graph TD
    A[Push to main/develop] --> B[Lint & Type Check]
    B --> C[Unit Tests]
    B --> D[E2E Tests ‚úÖ NUEVO]
    B --> E[Database Validation]
    
    C --> F{All tests pass?}
    D --> F
    E --> F
    
    F -->|Yes| G[Build Docker Image]
    F -->|No| H[‚ùå Pipeline Failed]
    
    G --> I[Push to ghcr.io]
    I --> J[‚úÖ Pipeline Success]
    
    D -.->|If failure| K[Upload Screenshots]
    D -.->|Always| L[Upload HTML Report]
```

## Jobs Detallados

### 1Ô∏è‚É£ Lint & Type Check
```bash
Duration: ~30s
Steps:
  - Setup Node.js 22
  - npm ci
  - npm run lint
  - npx tsc --noEmit
```

### 2Ô∏è‚É£ Unit Tests
```bash
Duration: ~45s
Steps:
  - Setup Node.js 22
  - npm ci
  - npm run test:unit -- --coverage
  - Upload coverage to Codecov

Tests: 3/3 passing ‚úÖ
Coverage: 0.12% (baseline)
```

### 3Ô∏è‚É£ E2E Tests ‚úÖ NUEVO
```bash
Duration: ~2-3 min
Steps:
  - Setup Node.js 22
  - Setup PostgreSQL 16 (service)
  - npm ci
  - Install Playwright browsers (Chromium)
  - npx prisma generate
  - npx prisma migrate deploy
  - npx prisma db seed (optional)
  - Run E2E tests with E2E_TESTING=true
  - Upload artifacts (report + screenshots)

Tests: 9/9 passing ‚úÖ
Browser: Chromium only (CI)
Auth: Bypass mode (no Clerk UI)
```

### 4Ô∏è‚É£ Database Validation
```bash
Duration: ~1 min
Steps:
  - Setup PostgreSQL 16 (service)
  - Setup Node.js 22
  - npm ci
  - npx prisma generate
  - npx prisma migrate deploy
  - npx prisma validate

Validates:
  ‚úì Schema syntax
  ‚úì Migrations deployable
  ‚úì No breaking changes
```

### 5Ô∏è‚É£ Build Docker Image
```bash
Duration: ~5-8 min
Steps:
  - Setup Docker Buildx
  - Login to ghcr.io
  - Extract metadata
  - Build and push image

Only runs if: ALL previous jobs pass
Triggers: Push to main/develop
Registry: ghcr.io/tucano1306/crm
```

## Artifacts

### Generated by E2E Tests

**playwright-report/** (Always uploaded)
- HTML report with test results
- Screenshots of passing tests
- Test duration and browser info
- Downloadable from GitHub Actions

**test-results/** (Only on failure)
- Screenshots of failing tests
- Videos of test execution
- Error context markdown files
- Retention: 7 days

### How to Access

1. Go to **Actions** tab in GitHub
2. Click on the workflow run
3. Scroll to **Artifacts** section
4. Download:
   - `playwright-report` - View full HTML report
   - `e2e-screenshots` - Debug failing tests

## Environment Variables

### Required for CI/CD

```bash
# GitHub Secrets (configurar en Settings ‚Üí Secrets)
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY  # Clerk public key
CLERK_SECRET_KEY                    # Clerk secret key
GITHUB_TOKEN                        # Auto-provided by GitHub

# Auto-configured in pipeline
DATABASE_URL=postgresql://test_user:test_password@localhost:5432/test_crm
E2E_TESTING=true
CI=true
NEXT_PUBLIC_API_URL=http://localhost:3000
```

## Pipeline Execution Time

```
Total duration: ~10-15 min (parallel jobs)

Breakdown:
  lint             ‚Üí  30s
  test-unit        ‚Üí  45s  ‚îê
  test-e2e         ‚Üí 2-3m  ‚îÇ Parallel
  database         ‚Üí  1m   ‚îò
  build            ‚Üí 5-8m  (after all pass)
```

## Success Criteria

‚úÖ **Pipeline passes if:**
- All linters pass
- All unit tests pass (3/3)
- All E2E tests pass (9/9)
- Database migrations valid
- Docker build succeeds

‚ùå **Pipeline fails if:**
- Lint errors exist
- Any test fails
- Database migration error
- Docker build error

## Local Testing

Before pushing to GitHub, validate locally:

```bash
# Run all checks locally
npm run lint
npm run test:unit -- --coverage
npm run test:e2e:bypass

# If all pass, safe to push
git push origin main
```

## Monitoring

**GitHub Actions Badge** (add to README.md):
```markdown
[![CI/CD Pipeline](https://github.com/tucano1306/CRM/actions/workflows/docker-ci-cd.yml/badge.svg)](https://github.com/tucano1306/CRM/actions/workflows/docker-ci-cd.yml)
```

**View pipeline:**
- https://github.com/tucano1306/CRM/actions

## Troubleshooting

### E2E tests fail in CI but pass locally

**Cause:** Timing differences, missing env vars

**Solution:**
```bash
# Check CI logs for:
- "E2E TEST MODE - Auth bypassed" (should appear)
- Database connection errors
- Missing environment variables
```

### Database migration fails

**Cause:** Schema changes not committed

**Solution:**
```bash
# Commit migrations before pushing
git add prisma/migrations
git commit -m "chore: Add database migration"
git push
```

### Build job skipped

**Cause:** Tests failed, or not a push event

**Solution:**
- Fix failing tests first
- Build only runs on push (not PR)
- Check `if: github.event_name == 'push'`

## Next Steps

1. ‚úÖ Add more E2E tests (catalog, orders, etc.)
2. ‚úÖ Increase coverage thresholds gradually
3. ‚úÖ Add integration tests (API endpoints)
4. ‚úÖ Enable other browsers (Firefox, WebKit)
5. ‚úÖ Add performance testing (Lighthouse)
6. ‚úÖ Add accessibility testing (axe)

---

**Last updated:** October 30, 2025  
**Pipeline version:** 2.0 (with E2E tests)
